PROCEDURE "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::SP_ACSY_KUNNR_UPDT" 
(OUT OT_STATUS NVARCHAR(1000)) 
	LANGUAGE SQLSCRIPT
	SQL SECURITY INVOKER 
	--DEFAULT SCHEMA <default_schema_name>
	--READS SQL DATA 
	AS
 BEGIN
-- Procedure Title : SP_ACSY_KUNNR_UPDT
--
-- Created By      : BC_EZ07674(Suresh Konidala)          Date :07/12/2016
-- 
-- Procedure Description : This is a stored procedure designed to update KUNNR and ECC TS 
--                        from COMM_CUST table to P77_ACSY_CUSTOMER table in NDB.
-- Project :Bell Canada
-- 
-- Release :R1/IFRS
--------------------------------------------------------------------------------
--   M O D I F I C A T I O N   H I S T O R Y
--------------------------------------------------------------------------------
-- Date        | User ID          | Modification History/Release
--------------------------------------------------------------------------------
--             |                  | 
--------------------------------------------------------------------------------
-- Description Of the changes 
--------------------------------------------------------------------------------
-- Modification Number          :<Assign Some Number> 
-- Description of Changes Made> :<Description of Changes>       
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
-- Local Variables Declaration
--------------------------------------------------------------------------------------------------
DECLARE LV_CUR_UTC 				TIMESTAMP := CURRENT_TIMESTAMP;
DECLARE LV_ERROR_FLAG 		NVARCHAR(1) := 'N';

DECLARE LC_SUCCESS_TEXT 		NVARCHAR(120) 
		DEFAULT 'OUT STATUS IS 0 :PROCEDURE IFRS_R1.COMMON_COMP.NDB_COMMON::SP_ACSY_KUNNR_UPDT 
								UPDATE EXECUTION SUCCESSFUL';
DECLARE LC_ERROR_TEXT 			NVARCHAR(120) 
         DEFAULT 'OUT STATUS IS 1 :PROCEDURE IFRS_R1.COMMON_COMP.NDB_COMMON::SP_ACSY_KUNNR_UPDT 
            					UPDATE EXECUTION FAILED';
--------------------------------------------------------------------------------------------------
-- Cursors Declaration
-------------------------------------------------------------------------------------------------- 
DECLARE CURSOR C_ACSY_KUNNR_UPDT FOR
	   SELECT
		 "UNIQUE_ACC_NO",
		 "KUNNR_SID",
		 "ECC_TS" 
		FROM "_SYS_BIC"."IFRS_R1.COMMON_COMP.NDB_COMMON/CA_ACSY_KUNNR_UPDT";
		
--------------------------------------------------------------------------------------------------
-- Local Temporary Tables Declaration
-------------------------------------------------------------------------------------------------- 
CREATE LOCAL TEMPORARY TABLE #UPDATE_EH_DELETION ("UNIQUE_ACC_NO" NVARCHAR(16));
--------------------------------------------------------------------------------------------------
-- Cursors Loop
--------------------------------------------------------------------------------------------------  

FOR ACSY_KUNNR AS C_ACSY_KUNNR_UPDT DO
	--  Define Exit Handler
	DECLARE EXIT HANDLER FOR SQLEXCEPTION 
	BEGIN AUTONOMOUS TRANSACTION 
	
	  -- Define Exit Handler
	  DECLARE EXIT HANDLER FOR SQLEXCEPTION 
	  BEGIN AUTONOMOUS TRANSACTION 	
	   
	     -- Do Nothing. Exception Handled to ensure SP does not get terminated 
	
 	  END;
	
   	  -- Insert record into error table
	  INSERT INTO "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::P77_ACSY_CUSTOMER_EH"
	   	  ("UNIQUE_ACC_NO",
     		"KUNNR_SID",
     		"MODIFIED_TS", 
			"ERROR_CODE",
			"TECHNICAL_MESSAGE",
			"ERROR_CREATE_TS")
	  VALUES( ACSY_KUNNR."UNIQUE_ACC_NO",
     		  ACSY_KUNNR."KUNNR_SID", 
     		  ACSY_KUNNR."ECC_TS", 
			  ::SQL_ERROR_CODE,
			  ::SQL_ERROR_MESSAGE,
			  LV_CUR_UTC); 
			   	    
	  LV_ERROR_FLAG := 'Y';    
	END;
	
	UPDATE "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::P77_ACSY_CUSTOMER"
	SET "KUNNR_SID" = ACSY_KUNNR."KUNNR_SID", "MODIFIED_TS" = ACSY_KUNNR."ECC_TS"
	WHERE "UNIQUE_ACC_NO" = ACSY_KUNNR."UNIQUE_ACC_NO";
	
	INSERT INTO #UPDATE_EH_DELETION
			      ("UNIQUE_ACC_NO") 
		   VALUES (ACSY_KUNNR."UNIQUE_ACC_NO");
END FOR ;
		
--------------------------------------------------------------------------------------------------
--  Update Error Table
--------------------------------------------------------------------------------------------------

	UPDATE "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::P77_ACSY_CUSTOMER_EH" A
    FROM "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::P77_ACSY_CUSTOMER_EH" A 
    INNER JOIN #UPDATE_EH_DELETION B
    ON A."UNIQUE_ACC_NO"            =   B."UNIQUE_ACC_NO"
    SET (DELETE_DATE, DELETED)      =   (CURRENT_DATE, 1);

--------------------------------------------------------------------------------------------------
-- Set Overall Status
-------------------------------------------------------------------------------------------------- 

--  STATUS 0: Send the success message to scheduling tool to confirm this procedure has been
--  executed successfully
    IF(LV_ERROR_FLAG = 'Y') THEN		

       OT_STATUS := LC_ERROR_TEXT;
			
    ELSE
 
  	   OT_STATUS := LC_SUCCESS_TEXT; 	
				
	END IF;
 
END;  