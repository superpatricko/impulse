PROCEDURE "NDB_MOBILITY"."IFRS_R1.MOBILITY.NDB_MOBILITY::SP_SUSPENDED_CUSTOMER_ZERO_DOLLAR_INVC" (  
	IN BAN NVARCHAR(9),
	IN SUBSCR_NO NVARCHAR(30),
	IN CUSTOMER_EFF_DT DATE) 
	
   LANGUAGE SQLSCRIPT 
	SQL SECURITY INVOKER 
	--DEFAULT SCHEMA <default_schema_name>
	--READS SQL DATA 
	AS
   BEGIN
    DECLARE RECORD_COUNT 	INTEGER;
    DECLARE LV_CUR_UTC 		TIMESTAMP := CURRENT_TIMESTAMP;

 
     CREATE LOCAL TEMPORARY TABLE #UPDATE_MOBL_POST_BILL
			("ITEM_ID" NVARCHAR(40),
			 "BAN" NVARCHAR(9) NOT NULL ,
			 "BILL_SEQ_NO" NVARCHAR(3),
			 "ENT_SEQ_NO" NVARCHAR(12) NOT NULL ,
			 "GL_ACCT_NO" NVARCHAR(12) NOT NULL ,
			 "ITEM_SUB_ID" NVARCHAR(6),
			 "JOURN_DT" DATE CS_DAYDATE NOT NULL ,
			 "SUBSCR_NO" NVARCHAR(30) NOT NULL ,
			 "DSCT_CD" NVARCHAR(40),
			 "ADJ_RSN_CD" NVARCHAR(9),
			 "CHRG_SEQ_NO" NVARCHAR(12),
			 "EFF_DT" DATE CS_DAYDATE,
			 "GL_COST_CENTRE" NVARCHAR(10),
			 "GL_JURISD_CD" NVARCHAR(4),
			 "GL_TAX_CD" NVARCHAR(1),
			 "PRD_CVRG_END_DT" DATE CS_DAYDATE,
			 "PRD_CVRG_STRT_DT" DATE CS_DAYDATE,
			 "PROMO_CD" NVARCHAR(9),
			 "PROV" NVARCHAR(2),
			 "UOM" NVARCHAR(1),
			 "ACCR_IND" NVARCHAR(1) NOT NULL ,
			 "ACTV_CD" NVARCHAR(4),
			 "ACTV_RSN_CD" NVARCHAR(9),
			 "AMT" DECIMAL(16,2) CS_FIXED NOT NULL ,
			 "BAL_IMP_CD" NVARCHAR(1),
			 "BILLER" NVARCHAR(4) NOT NULL ,
			 "OVER_USE_IND" NVARCHAR(1) NOT NULL ,
			 "TRANS_TY" NVARCHAR(4) NOT NULL ,
			 "ADJ_RSN_CLASS_CD" NVARCHAR(100),
			 "FTR_REV_CD" NVARCHAR(3),
			 "KUNNR_SID" NVARCHAR(10),
			 "GL_PRICE_PLAN_GRP" NVARCHAR(3),
			 "AR_ACTV" NVARCHAR(4) NOT NULL ,
			 "CR_DR_IND" NVARCHAR(1) NOT NULL ,
			 "CURR_CODE" NVARCHAR(3) NOT NULL ,
			 "VIRTUAL_INV_FLAG" NVARCHAR(1),
			 "REALLOCATION_IND" NVARCHAR(1) NOT NULL ,
			 "CUSTOMER_GROUP" NVARCHAR(2),
			 "MATERIAL_GROUP" NVARCHAR(9),
			 "REV_ACTG_DOC_NUM" NVARCHAR(10),
			 "BANNER" NVARCHAR(35),
			 "DEALER" NVARCHAR(40),
			 "REV_ACT_DOC_TY" NVARCHAR(2),
			 "ART_NUM" NVARCHAR(18),
			 "BRND" NVARCHAR(1),
			 "REFERENCE_ID" NVARCHAR(30),
			 "HEADER_ID" NVARCHAR(20),
			 "SOURCE_DOC_ID" NVARCHAR(60),
			 "ORIG_DOC_ID" NVARCHAR(60),
			 "TIME_IND" NVARCHAR(4),
			 "RAI_ITEM_ID" NVARCHAR(15),
			 "RUN_ID" INTEGER CS_INT,
			 "PMP_TS" LONGDATE CS_LONGDATE,
			 "CYCL_ID" NVARCHAR(3),
			 "EXECUTION_ID" NVARCHAR(10),
			 "CONVERSION_IND" NVARCHAR(1),
			 "INSERT_TS" LONGDATE CS_LONGDATE,
			 "MODIFIED_TS" LONGDATE CS_LONGDATE,
			 "BATCH_ID" INTEGER CS_INT,
			 "RAI_TS" LONGDATE CS_LONGDATE,
			 "CYCLE_NUM" NVARCHAR(3),
			 "BASE_OPT_SERV_IND" NVARCHAR(4),
			 "BILL_PRIMARY_KEY" NVARCHAR(100));	
		
		INSERT INTO #UPDATE_MOBL_POST_BILL
		  (  "ITEM_ID" ,
		     "BAN",
			 "BILL_SEQ_NO",
			 "ENT_SEQ_NO" ,
			 "GL_ACCT_NO",
			 "ITEM_SUB_ID",
			 "JOURN_DT" ,
			 "SUBSCR_NO" ,
			 "DSCT_CD" ,
			 "ADJ_RSN_CD",
			 "CHRG_SEQ_NO",
			 "EFF_DT",
			 "GL_COST_CENTRE" ,
			 "GL_JURISD_CD",
			 "GL_TAX_CD",
			 "PRD_CVRG_END_DT",
			 "PRD_CVRG_STRT_DT",
			 "PROMO_CD",
			 "PROV" ,
			 "UOM" ,
			 "ACCR_IND" ,
			 "ACTV_CD",
			 "ACTV_RSN_CD",
			 "AMT",
			 "BAL_IMP_CD",
			 "BILLER",
			 "OVER_USE_IND" ,
			 "TRANS_TY"  ,
			 "ADJ_RSN_CLASS_CD" ,
			 "FTR_REV_CD",
			 "KUNNR_SID" ,
			 "GL_PRICE_PLAN_GRP" ,
			 "AR_ACTV" ,
			 "CR_DR_IND" ,
			 "CURR_CODE" ,
			 "VIRTUAL_INV_FLAG" ,
			 "REALLOCATION_IND" ,
			 "CUSTOMER_GROUP" ,
			 "MATERIAL_GROUP",
			 "REV_ACTG_DOC_NUM" ,
			 "BANNER" ,
			 "DEALER" ,
			 "REV_ACT_DOC_TY",
			 "ART_NUM" ,
			 "BRND" ,
			 "REFERENCE_ID" ,
			 "HEADER_ID" ,
			 "SOURCE_DOC_ID" ,
			 "ORIG_DOC_ID" ,
			 "TIME_IND" ,
			 "RAI_ITEM_ID" ,
			 "RUN_ID" ,
			 "PMP_TS" ,
			 "CYCL_ID" ,
			 "EXECUTION_ID" ,
			 "CONVERSION_IND",
			 "INSERT_TS" ,
			 "MODIFIED_TS" ,
			 "BATCH_ID" ,
			 "RAI_TS" ,
			 "CYCLE_NUM",
			 "BASE_OPT_SERV_IND",
			 "BILL_PRIMARY_KEY")
			
			
	SELECT  "ITEM_ID" ,
             "BAN",
	         "BILL_SEQ_NO",
			 "ENT_SEQ_NO" ,
			 "GL_ACCT_NO",
			 "ITEM_SUB_ID",
			 "JOURN_DT" ,
			 "SUBSCR_NO" ,
			 "DSCT_CD" ,
			 "ADJ_RSN_CD",
			 "CHRG_SEQ_NO",
			 "EFF_DT",
			 "GL_COST_CENTRE" ,
			 "GL_JURISD_CD",
			 "GL_TAX_CD",
			 "PRD_CVRG_END_DT",
			 "PRD_CVRG_STRT_DT",
			 "PROMO_CD",
			 "PROV" ,
			 "UOM" ,
			 "ACCR_IND" ,
			 "ACTV_CD",
			 "ACTV_RSN_CD",
			 "AMT"  ,
			 "BAL_IMP_CD",
			 "BILLER",
			 "OVER_USE_IND" ,
			 "TRANS_TY"  ,
			 "ADJ_RSN_CLASS_CD" ,
			 "FTR_REV_CD",
			 "KUNNR_SID" ,
			 "GL_PRICE_PLAN_GRP" ,
			 "AR_ACTV" ,
			 "CR_DR_IND" ,
			 "CURR_CODE" ,
			 "VIRTUAL_INV_FLAG" ,
			 "REALLOCATION_IND" ,
			 "CUSTOMER_GROUP" ,
			 "MATERIAL_GROUP",
			 "REV_ACTG_DOC_NUM" ,
			 "BANNER" ,
			 "DEALER" ,
			 "REV_ACT_DOC_TY",
			 "ART_NUM" ,
			 "BRND" ,
			 "REFERENCE_ID" ,
			 "HEADER_ID" ,
			 "SOURCE_DOC_ID" ,
			 "ORIG_DOC_ID" ,
			 "TIME_IND" ,
			 "RAI_ITEM_ID" ,
			 "RUN_ID" ,
			 "PMP_TS" ,
			 "CYCL_ID" ,
			 "EXECUTION_ID" ,
			 "CONVERSION_IND",
			 "INSERT_TS" ,
			 "MODIFIED_TS" ,
			 "BATCH_ID" ,
			 "RAI_TS" ,
			 "CYCLE_NUM",
			 "BASE_OPT_SERV_IND",
			 "BILL_PRIMARY_KEY"
		FROM "NDB_MOBILITY"."IFRS_R1.MOBILITY.NDB_MOBILITY::MOBL_POST_BILL"
		WHERE BAN = :BAN 
		AND SUBSCR_NO = :SUBSCR_NO
		AND JOURN_DT =(SELECT MAX(JOURN_DT) FROM "NDB_MOBILITY"."IFRS_R1.MOBILITY.NDB_MOBILITY::MOBL_POST_BILL" 
		WHERE BAN = :BAN 
		AND SUBSCR_NO = :SUBSCR_NO )
		AND BASE_OPT_SERV_IND  ='BASE' ;
		
		SELECT COUNT(*) INTO RECORD_COUNT FROM #UPDATE_MOBL_POST_BILL;
		
	 	 IF RECORD_COUNT > 0 THEN
	 	 
		INSERT INTO "NDB_MOBILITY"."IFRS_R1.MOBILITY.NDB_MOBILITY::MOBL_POST_BILL"
		    ("ITEM_ID" ,
             "BAN",
	         "BILL_SEQ_NO",
			 "ENT_SEQ_NO" ,
			 "GL_ACCT_NO",
			 "ITEM_SUB_ID",
			 "JOURN_DT" ,
			 "SUBSCR_NO" ,
			 "DSCT_CD" ,
			 "ADJ_RSN_CD",
			 "CHRG_SEQ_NO",
			 "EFF_DT",
			 "GL_COST_CENTRE" ,
			 "GL_JURISD_CD",
			 "GL_TAX_CD",
			 "PRD_CVRG_END_DT",
			 "PRD_CVRG_STRT_DT",
			 "PROMO_CD",
			 "PROV" ,
			 "UOM" ,
			 "ACCR_IND" ,
			 "ACTV_CD",
			 "ACTV_RSN_CD",
			 "AMT"  ,
			 "BAL_IMP_CD",
			 "BILLER",
			 "OVER_USE_IND" ,
			 "TRANS_TY"  ,
			 "ADJ_RSN_CLASS_CD" ,
			 "FTR_REV_CD",
			 "KUNNR_SID" ,
			 "GL_PRICE_PLAN_GRP" ,
			 "AR_ACTV" ,
			 "CR_DR_IND" ,
			 "CURR_CODE" ,
			 "VIRTUAL_INV_FLAG" ,
			 "REALLOCATION_IND" ,
			 "CUSTOMER_GROUP" ,
			 "MATERIAL_GROUP",
			 "REV_ACTG_DOC_NUM" ,
			 "BANNER" ,
			 "DEALER" ,
			 "REV_ACT_DOC_TY",
			 "ART_NUM" ,
			 "BRND" ,
			 "REFERENCE_ID" ,
			 "HEADER_ID" ,
			 "SOURCE_DOC_ID" ,
			 "ORIG_DOC_ID" ,
			 "TIME_IND" ,
			 "RAI_ITEM_ID" ,
			 "RUN_ID" ,
			 "PMP_TS" ,
			 "CYCL_ID" ,
			 "EXECUTION_ID" ,
			 "CONVERSION_IND",
			 "INSERT_TS" ,
			 "MODIFIED_TS" ,
			 "BATCH_ID" ,
			 "RAI_TS" ,
			 "CYCLE_NUM",
			 "BASE_OPT_SERV_IND",
			 "BILL_PRIMARY_KEY")
			
	 SELECT "ITEM_ID" ,
             "BAN",
	         "BILL_SEQ_NO",
			 '9999' AS "ENT_SEQ_NO" ,
			 "GL_ACCT_NO",
			 "ITEM_SUB_ID",
			 :CUSTOMER_EFF_DT AS "JOURN_DT" ,
			 "SUBSCR_NO" ,
			 "DSCT_CD" ,
			 "ADJ_RSN_CD",
			 "CHRG_SEQ_NO",
			 :CUSTOMER_EFF_DT AS "EFF_DT",
			 "GL_COST_CENTRE" ,
			 "GL_JURISD_CD",
			 "GL_TAX_CD",
			 "PRD_CVRG_END_DT",
			 "PRD_CVRG_STRT_DT",
			 "PROMO_CD",
			 "PROV" ,
			 "UOM" ,
			 "ACCR_IND" ,
			 "ACTV_CD",
			 "ACTV_RSN_CD",
			 0.00 AS "AMT"  ,
			 "BAL_IMP_CD",
			 "BILLER",
			 "OVER_USE_IND" ,
			 "TRANS_TY"  ,
			 "ADJ_RSN_CLASS_CD" ,
			 "FTR_REV_CD",
			 "KUNNR_SID" ,
			 "GL_PRICE_PLAN_GRP" ,
			 "AR_ACTV" ,
			 "CR_DR_IND" ,
			 "CURR_CODE" ,
			 'X' AS "VIRTUAL_INV_FLAG" ,
			 "REALLOCATION_IND" ,
			 "CUSTOMER_GROUP" ,
			 "MATERIAL_GROUP",
			 "REV_ACTG_DOC_NUM" ,
			 "BANNER" ,
			 "DEALER" ,
			 "REV_ACT_DOC_TY",
			 "ART_NUM" , 
			 "BRND" ,
			 NULL AS "REFERENCE_ID" ,
			 NULL AS "HEADER_ID" ,
			 NULL AS "SOURCE_DOC_ID" ,
			 NULL AS "ORIG_DOC_ID" ,
			 NULL AS "TIME_IND" ,
			 NULL AS "RAI_ITEM_ID" ,
			 NULL AS "RUN_ID" ,
			 "PMP_TS" ,
			 "CYCL_ID" ,
			 "EXECUTION_ID" ,
			 "CONVERSION_IND",
			 LV_CUR_UTC AS "INSERT_TS" ,
			 LV_CUR_UTC AS "MODIFIED_TS" ,
			 NULL AS "BATCH_ID" ,
			 NULL AS "RAI_TS" ,
			 "CYCLE_NUM",
			 "BASE_OPT_SERV_IND",
			 "BILL_PRIMARY_KEY"
			FROM #UPDATE_MOBL_POST_BILL;
		
		ELSE IF RECORD_COUNT = 0 THEN
		INSERT INTO "NDB_MOBILITY"."IFRS_R1.MOBILITY.NDB_MOBILITY::MOBL_POST_BILL" 
		    (
             "BAN",
	         "ENT_SEQ_NO" ,
			 "GL_ACCT_NO",
			 "ITEM_SUB_ID",
			 "JOURN_DT" ,
			 "SUBSCR_NO" ,
			 "EFF_DT",
			 "AMT"  ,
			 "TRANS_TY"  ,
			 "CR_DR_IND" ,
			 "VIRTUAL_INV_FLAG" ,
			 "REFERENCE_ID" ,
			 "HEADER_ID" ,
			 "SOURCE_DOC_ID" ,
			 "ORIG_DOC_ID" ,
			 "TIME_IND" ,
			 "RAI_ITEM_ID" ,
			 "RUN_ID" ,
			 "INSERT_TS" ,
			 "MODIFIED_TS" ,
			 "BATCH_ID" ,
			 "RAI_TS" ,
			 "BASE_OPT_SERV_IND",
			 "ACCR_IND",
			 "BILLER",
			 "OVER_USE_IND",
			 "AR_ACTV",
			 "CURR_CODE" ,
			 "REALLOCATION_IND",
			 "BILL_PRIMARY_KEY"
			 )
		
		SELECT
             "BAN",
			 '9999' ,
			 "GL_ACCOUNT",
			 "ITEM_SUB_ID",
			 :CUSTOMER_EFF_DT AS "JOURN_DT",
			 "SUBSCR_NO" ,
			 :CUSTOMER_EFF_DT AS"EFF_DT",
			 0.00 ,
			 'CHG' ,
			 'C',
			 'X',
			 NULL,
			 NULL,
			 NULL,
			 NULL,
			 NULL,
			 NULL,
			 NULL,
			 LV_CUR_UTC ,
			 LV_CUR_UTC ,
			 NULL ,
			 NULL ,
			 "BASE_OPT_SERV_IND",
			 'Y',
			 'NM1',
			 'N',
			 'INV',
			 'CAD',
			 'N',
			 '123456'
		FROM "NDB_MOBILITY"."IFRS_R1.MOBILITY.NDB_MOBILITY::MOBL_POST_ORDER" 
		WHERE BAN = :BAN
		AND SUBSCR_NO = :SUBSCR_NO
		AND BASE_OPT_SERV_IND ='BASE';
		     
		
		
END IF;
END IF;

END;		
		