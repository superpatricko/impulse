PROCEDURE "NDB_HP"."IFRS_R1.HP.NDB_HP::SP_SUSPENDED_CUSTOMERS" ( 
	IN BAN NVARCHAR(9),
	IN SUBSCRIBER_NUMBER NVARCHAR(30),
	IN SUBSCR_ST NVARCHAR(1),
	IN CONT_TREAT_CODE NVARCHAR(10),
	IN CUSTOMER_EFF_DT DATE
) 
	LANGUAGE SQLSCRIPT
	SQL SECURITY INVOKER 
	--DEFAULT SCHEMA <default_schema_name>
	--READS SQL DATA 
	AS
BEGIN
	DECLARE RECORD_COUNT 	INTEGER;	
	DECLARE LV_CUR_UTC 		TIMESTAMP := CURRENT_TIMESTAMP;
	
--------------------------------------------------------------------------------------------------
-- Local Temporary Tables Declaration
--------------------------------------------------------------------------------------------------  

	CREATE LOCAL TEMPORARY TABLE #UPDATE_HP_NM1_ORDER
	( "BAN"   NVARCHAR(9) NOT NULL, 
	 "POB_END_DATE"   DATE , 
	 "POB_EFFV_DATE"   DATE , 
	 "SYSTEM_REGION"   NVARCHAR(4),
	 "SUBSCRIBER_NUMBER"   NVARCHAR(30), 
	 "TERM_M2M"   NVARCHAR(4), 
	 "BUSINESS_ID"   NVARCHAR(30) NOT NULL,
	 "SOC_CODE"   NVARCHAR(20) NOT NULL,
	 "FEATURE_CODE"   NVARCHAR(6) NOT NULL,
	 --"CHARGE_TYPE"   NVARCHAR(4),
	 "ITEM_RATE"   DECIMAL(17,3) CS_FIXED,
	 "ITEM_INCEPTION_DT"   DATE,
	 "ITEM_END_DT"   DATE,
	 "M2M_SERVICE_INDICATOR"   NVARCHAR(1),
	 "GL_ACCOUNT_NUMBER"   NVARCHAR(14),
	 "SUBSCRIBER_STATUS"   NVARCHAR(1) NOT NULL,
	 "DISCOUNT_TYPE"   NVARCHAR(4),
	 "DISCOUNT_PRICE"   DECIMAL(17,3),
	 "SOURCE_SYSTEM_CODE"   NVARCHAR(4),
	 "CONVERSION_IND"   NVARCHAR(1),
	 "KUNNR_SID"   NVARCHAR(10),
	 "CONTRACT_INCEPTION_DT"   DATE,
	 "PRODUCT_TYPE"   NVARCHAR(3) NOT NULL,
	 "COST_CENTRE"   INTEGER CS_INT,
	 "TAX_CODE"   NVARCHAR(2),
	 "PROMO_CD"   NVARCHAR(9),
	 "PROV"   NVARCHAR(2),
	 "TRANS_DT"   DATE NOT NULL,
	 "PREV_BAN"   NVARCHAR(9),
	 "PREV_CTN"   NVARCHAR(30),
	 "PREV_SUBS"   NVARCHAR(30),
	 "SUBS_TYPE"   NVARCHAR(1) NOT NULL,
	 "SUB_MKT_CODE"   NVARCHAR(3),
	 "SOC_SEQ_NUM"   DECIMAL(11,0) NOT NULL,
	 "SERV_FTR_SEQ_NO"   DECIMAL(11,0) NOT NULL,
	 "BASE_OPT_SERV_IND"   NVARCHAR(4),
	 "SERV_TY"   NVARCHAR(1), 
	 "SRCDOC_ID"   NVARCHAR(35),
	 "HEADER_ID"   NVARCHAR(20),
	 "REFERENCE_ID"   NVARCHAR(30),
	 "TIME_IND"   NVARCHAR(3),
	 "RAI_ITEM_ID"   NVARCHAR(15),
	 "PROCESS_ID"   INTEGER CS_INT,
	 "INSERT_TS"   TIMESTAMP,
	 "MODIFIED_TS"   TIMESTAMP,
	 "BATCH_ID"   NVARCHAR(10),
	 "BILL_DT"   DATE,
	 "MOD_IND"   NVARCHAR(1),
	 "CYCLE_ID"   NVARCHAR(3) NOT NULL,
	 "BUSINESS_ENTITY"   NVARCHAR(3),
	 "LEGAL_ENTITY"   NVARCHAR(3) NOT NULL,
	 "CONT_TREAT_CODE" NVARCHAR(10),
	 "PMP_TS" TIMESTAMP,
	 "RUN_ID" INTEGER CS_INT,
	 "RAI_TS" LONGDATE CS_LONGDATE		
	);
	
	 
	 INSERT INTO #UPDATE_HP_NM1_ORDER
	   ("BAN",
		"POB_END_DATE",
		"POB_EFFV_DATE",
		"SYSTEM_REGION",
		"SUBSCRIBER_NUMBER",
		"TERM_M2M",
		"BUSINESS_ID",
		"SOC_CODE",
		"FEATURE_CODE",
		--"CHARGE_TYPE",
		"ITEM_RATE",
		"ITEM_INCEPTION_DT",
		"ITEM_END_DT",
		"M2M_SERVICE_INDICATOR",
		"GL_ACCOUNT_NUMBER",
		"SUBSCRIBER_STATUS",
		"DISCOUNT_TYPE",
		"DISCOUNT_PRICE",
		"SOURCE_SYSTEM_CODE",
		"CONVERSION_IND",
		"KUNNR_SID",
		"CONTRACT_INCEPTION_DT",
		"PRODUCT_TYPE",
		"COST_CENTRE",
		"TAX_CODE",
		"PROMO_CD",
		"PROV",
		"TRANS_DT",
		"PREV_BAN",
		"PREV_CTN",
		"PREV_SUBS",
		"SUBS_TYPE",
		"SUB_MKT_CODE",
		"SOC_SEQ_NUM",
		"SERV_FTR_SEQ_NO",
		"BASE_OPT_SERV_IND",
		"SERV_TY",
		"SRCDOC_ID",
		"HEADER_ID",
		"REFERENCE_ID",
		"TIME_IND",
		"RAI_ITEM_ID",
		"PROCESS_ID",
		"INSERT_TS",
		"MODIFIED_TS",
		"BATCH_ID",
		"BILL_DT",
		"MOD_IND",
		"CYCLE_ID",
		"BUSINESS_ENTITY",
		"LEGAL_ENTITY",
		"CONT_TREAT_CODE",
		"RUN_ID",
		"RAI_TS",
		"PMP_TS")
		 
	 	select "BAN",
				"POB_END_DATE",
				"POB_EFFV_DATE",
				"SYSTEM_REGION",
				"SUBSCRIBER_NUMBER",
				"TERM_M2M",
				"BUSINESS_ID",
				"SOC_CODE",
				"FEATURE_CODE",
				--"CHARGE_TYPE",
				"ITEM_RATE",
				"ITEM_INCEPTION_DT",
				"ITEM_END_DT",
				"M2M_SERVICE_INDICATOR",
				"GL_ACCOUNT_NUMBER",
				"SUBSCRIBER_STATUS",
				"DISCOUNT_TYPE",
				"DISCOUNT_PRICE",
				"SOURCE_SYSTEM_CODE",
				"CONVERSION_IND",
				"KUNNR_SID",
				"CONTRACT_INCEPTION_DT",
				"PRODUCT_TYPE",
				"COST_CENTRE",
				"TAX_CODE",
				"PROMO_CD",
				"PROV",
				"TRANS_DT",
				"PREV_BAN",
				"PREV_CTN",
				"PREV_SUBS",
				"SUBS_TYPE",
				"SUB_MKT_CODE",
				"SOC_SEQ_NUM",
				"SERV_FTR_SEQ_NO",
				"BASE_OPT_SERV_IND",
				"SERV_TY",
				"SRCDOC_ID",
				"HEADER_ID",
				"REFERENCE_ID",
				"TIME_IND",
				"RAI_ITEM_ID",
				"PROCESS_ID",
				"INSERT_TS",
				"MODIFIED_TS",
				"BATCH_ID",
				"BILL_DT",
				"MOD_IND",
				"CYCLE_ID",
				"BUSINESS_ENTITY",
				"LEGAL_ENTITY",
				"CONT_TREAT_CODE",
				"RUN_ID",
				"RAI_TS",
				"PMP_TS"
		 from "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_NM1_ORDER"
		 where BAN = :BAN and SUBSCRIBER_NUMBER = :SUBSCRIBER_NUMBER
		 and POB_END_DATE = '99991231';
	 	 
	 	 
	 	 select count(*) into RECORD_COUNT from #UPDATE_HP_NM1_ORDER;
	 	 if RECORD_COUNT > 0 then
		 	-------------------------------------------------------------------------<
		 	----------------------------------------------------------------------------
		 	update "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_NM1_ORDER" o
		 	set o.POB_END_DATE = ADD_DAYS(:CUSTOMER_EFF_DT,-1),
		 	o.MODIFIED_TS = :LV_CUR_UTC
			where 
			o.BAN = :BAN and o.SUBSCRIBER_NUMBER = :SUBSCRIBER_NUMBER
			and o.POB_END_DATE = '99991231';
		 	
	 	 	INSERT INTO "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_NM1_ORDER"
			   ("BAN",
				"POB_END_DATE",
				"POB_EFFV_DATE",
				"SYSTEM_REGION",
				"SUBSCRIBER_NUMBER",
				"TERM_M2M",
				"BUSINESS_ID",
				"SOC_CODE",
				"FEATURE_CODE",
				--"CHARGE_TYPE",
				"ITEM_RATE",
				"ITEM_INCEPTION_DT",
				"ITEM_END_DT",
				"M2M_SERVICE_INDICATOR",
				"GL_ACCOUNT_NUMBER",
				"SUBSCRIBER_STATUS",
				"DISCOUNT_TYPE",
				"DISCOUNT_PRICE",
				"SOURCE_SYSTEM_CODE",
				"CONVERSION_IND",
				"KUNNR_SID",
				"CONTRACT_INCEPTION_DT",
				"PRODUCT_TYPE",
				"COST_CENTRE",
				"TAX_CODE",
				"PROMO_CD",
				"PROV",
				"TRANS_DT",
				"PREV_BAN",
				"PREV_CTN",
				"PREV_SUBS",
				"SUBS_TYPE",
				"SUB_MKT_CODE",
				"SOC_SEQ_NUM",
				"SERV_FTR_SEQ_NO",
				"BASE_OPT_SERV_IND",
				"SERV_TY",
				"SRCDOC_ID",
				"HEADER_ID",
				"REFERENCE_ID",
				"TIME_IND",
				"RAI_ITEM_ID",
				"PROCESS_ID",
				"INSERT_TS",
				"MODIFIED_TS",
				"BATCH_ID",
				"BILL_DT",
				"MOD_IND",
				"CYCLE_ID",
				"BUSINESS_ENTITY",
				"LEGAL_ENTITY",
				"CONT_TREAT_CODE",
				"RUN_ID",
				"RAI_TS",
				"PMP_TS")
		 
		 	select "BAN",					
					'99991231' , 	
					:CUSTOMER_EFF_DT,		
					"SYSTEM_REGION",
					"SUBSCRIBER_NUMBER",
					"TERM_M2M",
					"BUSINESS_ID",
					"SOC_CODE",
					"FEATURE_CODE",
					--"CHARGE_TYPE",
					"ITEM_RATE",
					"ITEM_INCEPTION_DT",					
					(CASE WHEN :CONT_TREAT_CODE = 'SUS' 
						  THEN (ADD_DAYS(:CUSTOMER_EFF_DT,-1)) 
						  ELSE null END) AS "ITEM_END_DT",
					"M2M_SERVICE_INDICATOR",
					"GL_ACCOUNT_NUMBER",
					:SUBSCR_ST,		
					"DISCOUNT_TYPE",
					"DISCOUNT_PRICE",
					"SOURCE_SYSTEM_CODE",
					"CONVERSION_IND",
					"KUNNR_SID",
					"CONTRACT_INCEPTION_DT",
					"PRODUCT_TYPE",
					"COST_CENTRE",
					"TAX_CODE",
					"PROMO_CD",
					"PROV",				
					"TRANS_DT",
					"PREV_BAN",
					"PREV_CTN",
					"PREV_SUBS",
					"SUBS_TYPE",
					"SUB_MKT_CODE",
					"SOC_SEQ_NUM",
					"SERV_FTR_SEQ_NO",
					"BASE_OPT_SERV_IND",
					"SERV_TY",
					"SRCDOC_ID",
					"HEADER_ID",
					"REFERENCE_ID",
					"TIME_IND",
					"RAI_ITEM_ID",
					"PROCESS_ID",
					:LV_CUR_UTC,
					:LV_CUR_UTC,
					"BATCH_ID",
					"BILL_DT",
					"MOD_IND",
					"CYCLE_ID",
					"BUSINESS_ENTITY",
					"LEGAL_ENTITY",
					:CONT_TREAT_CODE,
					"RUN_ID",
					 null,
					"PMP_TS"
			 from #UPDATE_HP_NM1_ORDER;
		 else
		 
		 	INSERT INTO #UPDATE_HP_NM1_ORDER
	 		("BAN",
			"POB_END_DATE",
			"POB_EFFV_DATE",
			"SYSTEM_REGION",
			"SUBSCRIBER_NUMBER",
			"TERM_M2M",
			"BUSINESS_ID",
			"SOC_CODE",
			"FEATURE_CODE",
			--"CHARGE_TYPE",
			"ITEM_RATE",
			"ITEM_INCEPTION_DT",
			"ITEM_END_DT",
			"M2M_SERVICE_INDICATOR",
			"GL_ACCOUNT_NUMBER",
			"SUBSCRIBER_STATUS",
			"DISCOUNT_TYPE",
			"DISCOUNT_PRICE",
			"SOURCE_SYSTEM_CODE",
			"CONVERSION_IND",
			"KUNNR_SID",
			"CONTRACT_INCEPTION_DT",
			"PRODUCT_TYPE",
			"COST_CENTRE",
			"TAX_CODE",
			"PROMO_CD",
			"PROV",
			"TRANS_DT",
			"PREV_BAN",
			"PREV_CTN",
			"PREV_SUBS",
			"SUBS_TYPE",
			"SUB_MKT_CODE",
			"SOC_SEQ_NUM",
			"SERV_FTR_SEQ_NO",
			"BASE_OPT_SERV_IND",
			"SERV_TY",
			"SRCDOC_ID",
			"HEADER_ID",
			"REFERENCE_ID",
			"TIME_IND",
			"RAI_ITEM_ID",
			"PROCESS_ID",
			"INSERT_TS",
			"MODIFIED_TS",
			"BATCH_ID",
			"BILL_DT",
			"MOD_IND",
			"CYCLE_ID",
			"BUSINESS_ENTITY",
			"LEGAL_ENTITY",
			"CONT_TREAT_CODE",
			"RUN_ID",
			"RAI_TS",
			"PMP_TS" )
			select 
			"BAN",
			"POB_END_DATE",
			"POB_EFFV_DATE",		
			"SYSTEM_REGION",
			"SUBSCRIBER_NUMBER",
			"TERM_M2M",
			"BUSINESS_ID",
			"SOC_CODE",
			"FEATURE_CODE",
			--"CHARGE_TYPE",
			"ITEM_RATE",
			"ITEM_INCEPTION_DT",
			"ITEM_END_DT",
			"M2M_SERVICE_INDICATOR",
			"GL_ACCOUNT_NUMBER",
			"SUBSCRIBER_STATUS",
			"DISCOUNT_TYPE",
			"DISCOUNT_PRICE",
			"SOURCE_SYSTEM_CODE",
			"CONVERSION_IND",
			"KUNNR_SID",
			"CONTRACT_INCEPTION_DT",
			"PRODUCT_TYPE",
			"COST_CENTRE",
			"TAX_CODE",
			"PROMO_CD",
			"PROV",
			"TRANS_DT",
			"PREV_BAN",
			"PREV_CTN",
			"PREV_SUBS",
			"SUBS_TYPE",
			"SUB_MKT_CODE",
			"SOC_SEQ_NUM",
			"SERV_FTR_SEQ_NO",
			"BASE_OPT_SERV_IND",
			"SERV_TY",
			"SRCDOC_ID",
			"HEADER_ID",
			"REFERENCE_ID",
			"TIME_IND",
			"RAI_ITEM_ID",
			"PROCESS_ID",
			"INSERT_TS",
			"MODIFIED_TS",
			"BATCH_ID",
			"BILL_DT",
			"MOD_IND",
			"CYCLE_ID",
			"BUSINESS_ENTITY",
			"LEGAL_ENTITY",
			"CONT_TREAT_CODE",
			"RUN_ID",
			"RAI_TS",
			"PMP_TS" 
			 from "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_NM1_ORDER" where 
			 SUBSCRIBER_NUMBER = :SUBSCRIBER_NUMBER and POB_END_DATE = '99991231';
			 
			 select count(*) into RECORD_COUNT from #UPDATE_HP_NM1_ORDER;
			 
			 if RECORD_COUNT > 0 then 
			 	
			 	-------------------------------------------------------------------------<
		 	    ----------------------------------------------------------------------------
			 	update "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_NM1_ORDER" o
			 	set o.POB_END_DATE = ADD_DAYS(:CUSTOMER_EFF_DT,-1),
			 	o.MODIFIED_TS = :LV_CUR_UTC
				where 
				o.SUBSCRIBER_NUMBER = :SUBSCRIBER_NUMBER
				and o.POB_END_DATE = '99991231';
				
	 	 	INSERT INTO "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_NM1_ORDER"
			   ("BAN",
				"POB_END_DATE",
				"POB_EFFV_DATE",
				"SYSTEM_REGION",
				"SUBSCRIBER_NUMBER",
				"TERM_M2M",
				"BUSINESS_ID",
				"SOC_CODE",
				"FEATURE_CODE",
				--"CHARGE_TYPE",
				"ITEM_RATE",
				"ITEM_INCEPTION_DT",
				"ITEM_END_DT",
				"M2M_SERVICE_INDICATOR",
				"GL_ACCOUNT_NUMBER",
				"SUBSCRIBER_STATUS",
				"DISCOUNT_TYPE",
				"DISCOUNT_PRICE",
				"SOURCE_SYSTEM_CODE",
				"CONVERSION_IND",
				"KUNNR_SID",
				"CONTRACT_INCEPTION_DT",
				"PRODUCT_TYPE",
				"COST_CENTRE",
				"TAX_CODE",
				"PROMO_CD",
				"PROV",
				"TRANS_DT",
				"PREV_BAN",
				"PREV_CTN",
				"PREV_SUBS",
				"SUBS_TYPE",
				"SUB_MKT_CODE",
				"SOC_SEQ_NUM",
				"SERV_FTR_SEQ_NO",
				"BASE_OPT_SERV_IND",
				"SERV_TY",
				"SRCDOC_ID",
				"HEADER_ID",
				"REFERENCE_ID",
				"TIME_IND",
				"RAI_ITEM_ID",
				"PROCESS_ID",
				"INSERT_TS",
				"MODIFIED_TS",
				"BATCH_ID",
				"BILL_DT",
				"MOD_IND",
				"CYCLE_ID",
				"BUSINESS_ENTITY",
				"LEGAL_ENTITY",
				"CONT_TREAT_CODE",
				"RUN_ID",
				"RAI_TS",
				"PMP_TS")
		 
		 	select "BAN",					
					'99991231' , 	
					:CUSTOMER_EFF_DT,
					"SYSTEM_REGION",
					"SUBSCRIBER_NUMBER",
					"TERM_M2M",
					"BUSINESS_ID",
					"SOC_CODE",
					"FEATURE_CODE",
					--"CHARGE_TYPE",
					"ITEM_RATE",
					"ITEM_INCEPTION_DT",
					(CASE WHEN :CONT_TREAT_CODE = 'SUS' 
						  THEN (ADD_DAYS(:CUSTOMER_EFF_DT,-1)) 
						  ELSE null END) AS "ITEM_END_DT",
					"M2M_SERVICE_INDICATOR",
					"GL_ACCOUNT_NUMBER",
					:SUBSCR_ST,		
					"DISCOUNT_TYPE",
					"DISCOUNT_PRICE",
					"SOURCE_SYSTEM_CODE",
					"CONVERSION_IND",
					"KUNNR_SID",
					"CONTRACT_INCEPTION_DT",
					"PRODUCT_TYPE",
					"COST_CENTRE",
					"TAX_CODE",
					"PROMO_CD",
					"PROV",
					"TRANS_DT",
					"PREV_BAN",
					"PREV_CTN",
					"PREV_SUBS",
					"SUBS_TYPE",
					"SUB_MKT_CODE",
					"SOC_SEQ_NUM",
					"SERV_FTR_SEQ_NO",
					"BASE_OPT_SERV_IND",
					"SERV_TY",
					"SRCDOC_ID",
					"HEADER_ID",
					"REFERENCE_ID",
					"TIME_IND",
					"RAI_ITEM_ID",
					"PROCESS_ID",
					:LV_CUR_UTC,
					:LV_CUR_UTC,
					"BATCH_ID",
					"BILL_DT",
					"MOD_IND",
					"CYCLE_ID",
					"BUSINESS_ENTITY",
					"LEGAL_ENTITY",
					:CONT_TREAT_CODE,
					"RUN_ID",
					 null,
					"PMP_TS"
			 from #UPDATE_HP_NM1_ORDER;				
			 	
	 	
			 end if;
		 
	 	 end if; 
	 	 
	
END;
	
	