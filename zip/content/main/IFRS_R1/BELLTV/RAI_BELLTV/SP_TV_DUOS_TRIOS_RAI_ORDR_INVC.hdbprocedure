PROCEDURE "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::SP_TV_DUOS_TRIOS_RAI_ORDR_INVC"
(IN IP_EXTR_DT DATE,
OUT OP_STATUS NVARCHAR(1000))  
	LANGUAGE SQLSCRIPT
	SQL SECURITY INVOKER  
	AS
BEGIN


----------------------------------------------------------------------------------------------------
-- Procedure Title : IFRS_R1.BELLTV.RAI_BELLTV::SP_TV_DUOS_TRIOS_RAI_ORDR
----------------------------------------------------------------------------------------------------
-- Created By      : BC_EZ04919(SAHITHI)          Date :25/09/2017
----------------------------------------------------------------------------------------------------
-- Procedure Description : 
--   This procedure will create RAI Order Main and Condition Items based on NDB BELL TV Order data.
--   The Order RAI Items will be created:
--		 1. Every month in case of M2M contracts.
--		 2. Once for Term contracts.
--		 3. In case of Modification events which are:
--			a. Account Disconnect
--			b. Term Disqualification
    

--   for term contract, SSP and TP will be calcualted for the entire contract period
                           
--   This Procedure has two parameters:
--	   	1. The date parameter 'IP_EXTR_DT': Using this date parameter,
--	   	   RAI item	can be created for past records(if it is required).
--      2. The  OT_STATUS parametere : This parameter give the status of the Procedure whether it is 
--         success or failure

-- ERROR_LOG Table : Will be used to trace the system error like transaction failed.

-- FREQUENCY OF PROCEDURE EXECUTION: Daily

-- Track Error/Process Control Table: This table will be used to tract the start and end
-- time of the execution
----------------------------------------------------------------------------------------------------
-- Release :R1/IFRS

----------------------------------------------------------------------------------------------------
-- M O D I F I C A T I O N   H I S T O R Y
----------------------------------------------------------------------------------------------------
-- Date        | User ID          | Modification History/Release
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
-- Description Of the changes 
----------------------------------------------------------------------------------------------------
-- Modification Number          :<Assign Some Number> 
-- Description of Changes Made> :<Updated the logic of NDB_TS write back>       
----------------------------------------------------------------------------------------------------


/* Declaring Local Variables */

DECLARE LV_BATCH_ID       		INTEGER;
DECLARE LV_COUNT                INTEGER;
DECLARE LV_ERROR_FLAG 		    NVARCHAR(1) := 'N';
DECLARE LV_CUR_UTC 				TIMESTAMP := CURRENT_TIMESTAMP;
DECLARE LV_CUR_UTC_TIME 		DECIMAL(15,2) 
                                := TO_DECIMAL(TO_CHAR(CURRENT_UTCTIMESTAMP,'YYYYMMDDHHMISS'),15,2);                            
DECLARE LC_ERROR_TEXT 		    NVARCHAR(70) DEFAULT 'OUT STATUS IS 1 : INSERT/UPDATE FOR ONE OR MORE RECORD FAILED';
DECLARE LC_SUCCESS_TEXT 	    NVARCHAR(70) DEFAULT 'OUT STATUS IS 0 : INSERT/UPDATE EXECUTION SUCCESSFUL';
DECLARE i					    INTEGER;

DECLARE CURRENT_ERROR		    NVARCHAR(100);
DECLARE ERROR_TAB 			    TABLE (ERROR_CODE NVARCHAR(100));
DECLARE RECORD_COUNT		    INTEGER;
DECLARE LC_SET		  			NVARCHAR (1) DEFAULT 'X';
DECLARE LV_REFERENCE_ID	        NVARCHAR (25) ;
DECLARE LV_SRCDOC_ID            NVARCHAR (35) ;
DECLARE LV_SRCDOC_ID_DTH        NVARCHAR (35) ;
DECLARE LV_SRCDOC_ID_FIBE       NVARCHAR (35) ;
DECLARE LV_SRCDOC_ID_HP         NVARCHAR (35) ;
DECLARE LV_SRCDOC_ID_INT        NVARCHAR (35) ;

--------------------------------------------------------------------------------------------------
-- Temporary table/Variable/Node Declaration to hold data from the final CVs
-------------------------------------------------------------------------------------------------- 

   DECLARE CURSOR C_RAI_ORDR_INVC FOR
			SELECT
			 "ERROR_STATUS",
			 "ERROR_CODE",
			 "ZZ_AUFNR",
			 "ZZ_TXJCD",
			 "ZZ_ZUONR_ORD",
			 "ZZ_SGTXT",
			 "ZZ_MATNR",
			 "ZZ_XBLNR",
			 "ZZ_MINPRICE",
			 "ZZ_BILLER",
			 "ZZ_BU_VIEW",
			 "ZZ_ADJ_RSN_CD",
			 "ZZ_CONVERSION",
			 "ZZ_BKTXT",
			 "ZZ_BLDAT",
			 "ZZ_BUDAT",
			 "BUKRS",
			 "PL_ACCOUNT",
			 "ZZ_BUKRS",
			 "ZZ_ICHKONT",
			 "ZZ_KOSTL",
			 "SSP",
			 "TP",
			 "RAI_ITEM_ID", 
			 "SRCDOC_ID",
			 "SRCDOC_COMP",
			 "SRCDOC_LOGSYS",
			 "SRCDOC_TYPE",
			 "REFERENCE_TYPE",
			 "WAERS",
			 "RECEIV_ACCOUNT",
			 "ZZ_LEGACY",
			 "ZZ_MWSKZ",
			 "ZZ_MATNR_GRP",
			 "VALUE_RELEVANT",
			 "END_DATE",
			 "START_DATE",
			 "MAIN_CONDITION_TYPE",
			 "CATEGORY",
			 "CONDITION_TYPE_TP",
			 "CONDITION_TYPE_SSP",
			 "INCEPTION_DT",
			 "BILREL",
			 "QUANTITY_UNIT",
			 "QUANTITY",
			 "KUNNR",
			 "HEADER_ID",
			 to_decimal("TIMESTAMP_UTC",15,0) TIMESTAMP_UTC,
			 "REFERENCE_ID",
			 "XNEGATIVE_ITEM",
			 "INSERT_TS",
			 "SRC_TS",
			 "SYS_NUM",
			 "EXTR_TM",
			 "CNVR_IND",
			 "INSTALL_NUM",
			 "FEAT_CD",
			 "BILL_TO_DT",
			 "BILL_FROM_DT",
			 "KUNNR_SID",
			 "REVENUE_CD",
			 "BILL_CD",
			 "CUST_TY",
			 "NETWK_TY",
			 "PRODUCT_TYPE",
			 "TERM_IND",
			 "VIRTUAL_IND",
			 "CUST_ST",
			 "BILL_CYCL",
			 "PRE_DSCT_CHRG",
			 "DSCT_AMT",
			 "DSCT_CD",
			 "DUO_TRIO_IND",
			 "CYCL_ID",
			 "ENTR_REF_NUM",
			 "ADJ_ENTR_REF",
			 "VTG_ROW_ID",
			 "CONTR_TERM_DT",
			 "TERM_DISQUALF_IND",
			 "AMT",
			 "CONTR_TY",
			 "CONTR_TERM",
			 "CONTR_STRT_DT",
			 "CONTR_END_DT",
			 "CO_CD",
			 "AUDT_TRL_DT",
			 "POST_DT",
			 "TRANS_DT",
			 "ADJ_RSN_CD",
			 "SERVICE_CD",
			 "TRAN_CD",
			 "AGNT_NUM",
			 "PRIN_NUM",
			 "ACCT_NUM",
			 "EXTR_DT",
			 "ZZ_ZUONR_INV",
			 "FINAL_INVOICE",
			 "DUE_DATE",
			 "QUANTITY_REL",
			 "POSTING_DT",
			 "EXCHANGE_RATE",
			 "SRCDOC_COMP_INV",
			 "SRCDOC_LOGSYS_INV",
			 "SRCDOC_TYPE_INV",
			 "HWAER",
			 "DTH_SRCDOC_ID",
	         "FIBE_SRCDOC_ID",
	         "INT_SRCDOC_ID",
	         "HP_SRCDOC_ID",
	         "CC_TEMP_SRCDOC_ID"			 				  
			FROM "_SYS_BIC"."IFRS_R1.BELLTV.RAI_BELLTV/CA_TV_DUOS_TRIOS_ORDR_INVC_RAI_ITEM"
			(PLACEHOLDER."$$IP_BILL_DAY$$" => IFNULL(:IP_EXTR_DT,'99991231'))
			ORDER BY REFERENCE_ID, CC_TEMP_SRCDOC_ID;
				
  BEGIN    

	--------------------------------------------------------------------------------------------------
	-- Batch ID creation for RAI processing
	-------------------------------------------------------------------------------------------------- 			 
	
	SELECT "RAI_COMMON"."IFRS_R1.COMMON_COMP.RAI_COMMON::RAI_BATCH_ID".NEXTVAL 
	  INTO LV_BATCH_ID 
	  FROM DUMMY;	
		 
	--------------------------------------------------------------------------------------------------
	-- Local Temporary Tables Declaration
	-------------------------------------------------------------------------------------------------- 			 	   	   
	
	CREATE LOCAL TEMPORARY TABLE #UPDATE_TV_ORDER(
	    ACCT_NUM    				NVARCHAR(16), 
		ITEM_ID                     NVARCHAR(20),
		SRCDOC_ID                   NVARCHAR(35),
		DTH_SRCDOC_ID               NVARCHAR(35),
		FIBE_SRCDOC_ID              NVARCHAR(35),
		HP_SRCDOC_ID                NVARCHAR(35),
		INT_SRCDOC_ID               NVARCHAR(35),
		SRCDOC_ID_NDB               NVARCHAR(85),
		REFERENCE_ID                NVARCHAR(30),
		SERVICE_CD                  NVARCHAR(15),
		BATCH_ID                    INTEGER,
		RAI_TS						DATE,
		RUN_ID						INTEGER,
		EXTR_DT						DATE,
		VTG_ROW_ID	                NVARCHAR(18),
		PRIN_NUM                    NVARCHAR(4),
		AGNT_NUM	                NVARCHAR(4));
	    
	CREATE LOCAL TEMPORARY TABLE #UPDATE_EH_DELETION_MAIN_TV (SRCDOC_ID NVARCHAR(35));
	
	CREATE LOCAL TEMPORARY TABLE #UPDATE_EH_DELETION_COND_TV (SRCDOC_ID NVARCHAR(35));

	--------------------------------------------------------------------------------------------------
	-- Cursors Loop
	-------------------------------------------------------------------------------------------------- 
	
	FOR CUR_ORDR_INVC AS C_RAI_ORDR_INVC DO
	
	--  Check the Error Status of the Record. 
	
		IF CUR_ORDR_INVC.ERROR_STATUS = '1' 
		THEN
		
    --  	Call the Stored Procedure to split the concatenated Error Messages into Error Rows
		CALL "NDB_COMMON"."IFRS_R1.COMMON_COMP.EH::SP_EH_SPLIT_ERRORS"(CUR_ORDR_INVC."ERROR_CODE",ERROR_TAB,RECORD_COUNT);
	
    --	    Loop through the Error Records
			FOR i IN 1 .. :RECORD_COUNT DO
				
    --      	Fetch the Error Code
				CURRENT_ERROR = :ERROR_TAB."ERROR_CODE"[:i];
				
	--  		All erroneous records are inserted into Order Main EH table 
				INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_MAIN_EH"(
							"SRCDOC_COMP",			
							"SRCDOC_LOGSYS",
							"SRCDOC_TYPE",
							"SRCDOC_ID",
							"TIMESTAMP_UTC",
							"HEADER_ID",
							"ITEM_ID",
							"REFERENCE_TYPE",
							"REFERENCE_ID",
							"KUNNR",
							"BUKRS",
							"WAERS",
							"QUANTITY",
							"QUANTITY_UNIT",
							"BILREL",
							"START_DATE",
							"END_DATE",
							"XNEGATIVE_ITEM",
							"RECEIV_ACCOUNT",
							"INCEPTION_DATE",
							"ZZ_AUFNR",
							"ZZ_BATCH_ID",
							"ZZ_BILLER",
							"ZZ_BKTXT",
							"ZZ_BU_VIEW",
							"ZZ_BUKRS",
							"ZZ_KOSTL",
							"ZZ_LEGACY",
							"ZZ_MATNR",
							"ZZ_MATNR_GRP",
							"ZZ_MINPRICE",
							"ZZ_MWSKZ",
							"ZZ_SGTXT",
							"ZZ_TXJCD",
							"ZZ_XBLNR",
							"ZZ_ZUONR",
							"VALUE_RELEVANT",
							"ERROR_CODE",
						    "ERROR_CREATE_TS")
				VALUES (CUR_ORDR_INVC."SRCDOC_COMP",
						CUR_ORDR_INVC."SRCDOC_LOGSYS",
						CUR_ORDR_INVC."SRCDOC_TYPE",
						CUR_ORDR_INVC."SRCDOC_ID",
						CUR_ORDR_INVC."TIMESTAMP_UTC",
						CUR_ORDR_INVC."HEADER_ID",
						CUR_ORDR_INVC."RAI_ITEM_ID",
						CUR_ORDR_INVC."REFERENCE_TYPE",
						CUR_ORDR_INVC."REFERENCE_ID",
						CUR_ORDR_INVC."KUNNR",
						CUR_ORDR_INVC."BUKRS",
						CUR_ORDR_INVC."WAERS",
						CUR_ORDR_INVC."QUANTITY",
						CUR_ORDR_INVC."QUANTITY_UNIT",
						CUR_ORDR_INVC."BILREL",
						CUR_ORDR_INVC."START_DATE",
						CUR_ORDR_INVC."END_DATE",
						CUR_ORDR_INVC."XNEGATIVE_ITEM",
						CUR_ORDR_INVC."RECEIV_ACCOUNT",
						CUR_ORDR_INVC."INCEPTION_DT",
						CUR_ORDR_INVC."ZZ_AUFNR",
						:LV_BATCH_ID,
						CUR_ORDR_INVC."ZZ_BILLER",
						CUR_ORDR_INVC."ZZ_BKTXT",
						CUR_ORDR_INVC."ZZ_BU_VIEW",
						CUR_ORDR_INVC."ZZ_BUKRS",
						CUR_ORDR_INVC."ZZ_KOSTL",
						CUR_ORDR_INVC."ZZ_LEGACY",
						CUR_ORDR_INVC."ZZ_MATNR",
						CUR_ORDR_INVC."ZZ_MATNR_GRP",
						CUR_ORDR_INVC."ZZ_MINPRICE",
						CUR_ORDR_INVC."ZZ_MWSKZ",
						CUR_ORDR_INVC."ZZ_SGTXT",
						CUR_ORDR_INVC."ZZ_TXJCD",
						CUR_ORDR_INVC."ZZ_XBLNR",
						CUR_ORDR_INVC."ZZ_ZUONR_ORD",
						CUR_ORDR_INVC."VALUE_RELEVANT",
					    :CURRENT_ERROR,
						LV_CUR_UTC);
			
	--  		All erroneous records are inserted into Order Condition EH Table for SSP(Standalone Selling Price)
		   		INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_COND_EH"(
							"SRCDOC_COMP",
							"SRCDOC_LOGSYS",
							"SRCDOC_TYPE",
							"SRCDOC_ID",
							"TIMESTAMP_UTC",
							"CONDITION_TYPE",
							"PL_ACCOUNT",			
							"BETRW",
							"WAERS",
							"CATEGORY",
							"MAIN_COND_TYPE",
							"ERROR_CODE",
						    "ERROR_CREATE_TS")
				    VALUES (CUR_ORDR_INVC."SRCDOC_COMP",
							CUR_ORDR_INVC."SRCDOC_LOGSYS",			
							CUR_ORDR_INVC."SRCDOC_TYPE",
							CUR_ORDR_INVC."SRCDOC_ID",
							CUR_ORDR_INVC."TIMESTAMP_UTC",
							CUR_ORDR_INVC."CONDITION_TYPE_SSP",
							CUR_ORDR_INVC."PL_ACCOUNT",
							CUR_ORDR_INVC."SSP",
							CUR_ORDR_INVC."WAERS",
							CUR_ORDR_INVC."CATEGORY",
							CUR_ORDR_INVC."MAIN_CONDITION_TYPE",
							:CURRENT_ERROR,
						    LV_CUR_UTC);		
			
	--  		All erroneous records are inserted into Order Condition EH Table for TP(Transaction Price)
		        INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_COND_EH"(
							"SRCDOC_COMP",
							"SRCDOC_LOGSYS",
							"SRCDOC_TYPE",
							"SRCDOC_ID",
							"TIMESTAMP_UTC",
							"CONDITION_TYPE",
							"PL_ACCOUNT",			
							"BETRW",
							"WAERS",
							"CATEGORY",
							"MAIN_COND_TYPE",
							"ERROR_CODE",
						    "ERROR_CREATE_TS")
				    VALUES (CUR_ORDR_INVC."SRCDOC_COMP",
							CUR_ORDR_INVC."SRCDOC_LOGSYS",			
							CUR_ORDR_INVC."SRCDOC_TYPE",
							CUR_ORDR_INVC."SRCDOC_ID",
							CUR_ORDR_INVC."TIMESTAMP_UTC",
							CUR_ORDR_INVC."CONDITION_TYPE_TP",
							CUR_ORDR_INVC."PL_ACCOUNT",
							CUR_ORDR_INVC."TP",
							CUR_ORDR_INVC."WAERS",
							CUR_ORDR_INVC."CATEGORY",
							CUR_ORDR_INVC."MAIN_CONDITION_TYPE",
							:CURRENT_ERROR,
						    LV_CUR_UTC);
						    
			INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_INVC_MAIN_EH"(
									"SRCDOC_COMP",
									"SRCDOC_LOGSYS",
									"SRCDOC_TYPE",
									"SRCDOC_ID",
									"TIMESTAMP_UTC",
									"HEADER_ID",
									"ITEM_ID",
									"KUNNR",
									"BUKRS",
									"WAERS",
									"HWAER",
									"QUANTITY",
									"QUANTITY_UNIT",
									"ORIGDOC_COMP",
									"ORIGDOC_LOGSYS",
									"ORIGDOC_TYPE",
									"ORIGDOC_ID",
									"DUE_DATE",
									"FINAL_INVOICE",
									"QUANTITY_REL",
									"POSTING_DATE",
									"EXCHANGE_RATE",
									"BLDAT",
									"ZZ_AUFNR",
									"ZZ_BATCH_ID",
									"ZZ_BKTXT",
									"ZZ_BLDAT",
									"ZZ_BUDAT",
									"ZZ_BUKRS",
									"ZZ_ICHKONT",
									"ZZ_KOSTL",
									"ZZ_LEGACY",
									"ZZ_MWSKZ",
									"ZZ_SGTXT",
									"ZZ_TXJCD",
									"ZZ_XBLNR",
									"ZZ_ZUONR",
									"ERROR_CODE",
								    "ERROR_CREATE_TS")
							VALUES (CUR_ORDR_INVC."SRCDOC_COMP_INV",
									CUR_ORDR_INVC."SRCDOC_LOGSYS_INV",
									CUR_ORDR_INVC."SRCDOC_TYPE_INV",
									CUR_ORDR_INVC."SRCDOC_ID",
									CUR_ORDR_INVC."TIMESTAMP_UTC",
									CUR_ORDR_INVC."HEADER_ID",
									CUR_ORDR_INVC."RAI_ITEM_ID",
									CUR_ORDR_INVC."KUNNR",
									CUR_ORDR_INVC."BUKRS",
									CUR_ORDR_INVC."WAERS",
									CUR_ORDR_INVC."HWAER",
									CUR_ORDR_INVC."QUANTITY",
									CUR_ORDR_INVC."QUANTITY_UNIT",
									CUR_ORDR_INVC."SRCDOC_COMP",
									CUR_ORDR_INVC."SRCDOC_LOGSYS",
									CUR_ORDR_INVC."SRCDOC_TYPE",
									CUR_ORDR_INVC."SRCDOC_ID",
									CUR_ORDR_INVC."DUE_DATE",
									CUR_ORDR_INVC."FINAL_INVOICE",
									CUR_ORDR_INVC."QUANTITY_REL",
									CUR_ORDR_INVC."POSTING_DT",
									CUR_ORDR_INVC."EXCHANGE_RATE",
									CUR_ORDR_INVC."ZZ_BLDAT",
									CUR_ORDR_INVC."ZZ_AUFNR",
									LV_BATCH_ID,
									CUR_ORDR_INVC."ZZ_BKTXT",
									CUR_ORDR_INVC."ZZ_BLDAT",
									CUR_ORDR_INVC."ZZ_BUDAT",
									CUR_ORDR_INVC."ZZ_BUKRS",
									CUR_ORDR_INVC."ZZ_ICHKONT",
									CUR_ORDR_INVC."ZZ_KOSTL",
									CUR_ORDR_INVC."ZZ_LEGACY",
									CUR_ORDR_INVC."ZZ_MWSKZ",
									CUR_ORDR_INVC."ZZ_SGTXT",
									CUR_ORDR_INVC."ZZ_TXJCD",
									CUR_ORDR_INVC."ZZ_XBLNR",
									CUR_ORDR_INVC."ZZ_ZUONR_INV",
								    :CURRENT_ERROR,
									LV_CUR_UTC);
						
	--  		All erroneous records are inserted into Invoice Condition EH Table for TP(Transactional Price)
		   		INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_INVC_COND_EH"(
							"SRCDOC_COMP",
							"SRCDOC_LOGSYS",
							"SRCDOC_TYPE",
							"SRCDOC_ID",
							"TIMESTAMP_UTC",
							"CONDITION_TYPE",
							"PL_ACCOUNT",			
							"BETRW",
							"WAERS",
							"CATEGORY",
							"MAIN_COND_TYPE",
							"ERROR_CODE",
						    "ERROR_CREATE_TS")
				    VALUES (CUR_ORDR_INVC."SRCDOC_COMP_INV",
							CUR_ORDR_INVC."SRCDOC_LOGSYS_INV",			
							CUR_ORDR_INVC."SRCDOC_TYPE_INV",
							CUR_ORDR_INVC."SRCDOC_ID",
							CUR_ORDR_INVC."TIMESTAMP_UTC",
							CUR_ORDR_INVC."CONDITION_TYPE_TP",
							CUR_ORDR_INVC."PL_ACCOUNT",
							CUR_ORDR_INVC."TP",
							CUR_ORDR_INVC."WAERS",
							CUR_ORDR_INVC."CATEGORY",
							CUR_ORDR_INVC."MAIN_CONDITION_TYPE",
							:CURRENT_ERROR,
						    LV_CUR_UTC);		
	--  		Set Error Flag				        
				LV_ERROR_FLAG := 'Y';
				
			END FOR;
 
	
	--	Processing of successful records
		ELSE
		
			BEGIN AUTONOMOUS TRANSACTION
			
	--  		All valid records are inserted into Order Main table 
				INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_MAIN"(
						"SRCDOC_COMP",			
						"SRCDOC_LOGSYS",
						"SRCDOC_TYPE",
						"SRCDOC_ID",
						"TIMESTAMP_UTC",
						"HEADER_ID",
						"ITEM_ID",
						"REFERENCE_TYPE",
						"REFERENCE_ID",
						"KUNNR",
						"BUKRS",
						"WAERS",
						"QUANTITY",
						"QUANTITY_UNIT",
						"BILREL",
						"START_DATE",
						"END_DATE",
						"XNEGATIVE_ITEM",
						"RECEIV_ACCOUNT",
						"INCEPTION_DATE",
						"ZZ_AUFNR",
						"ZZ_BATCH_ID",
						"ZZ_BILLER",
						"ZZ_BKTXT",
						"ZZ_BU_VIEW",
						"ZZ_BUKRS",
						"ZZ_KOSTL",
						"ZZ_LEGACY",
						"ZZ_MATNR",
						"ZZ_MATNR_GRP",
						"ZZ_MINPRICE",
						"ZZ_MWSKZ",
						"ZZ_SGTXT",
						"ZZ_TXJCD",
						"ZZ_XBLNR",
						"ZZ_ZUONR",
						"VALUE_RELEVANT")
					VALUES (CUR_ORDR_INVC."SRCDOC_COMP",
						CUR_ORDR_INVC."SRCDOC_LOGSYS",
						CUR_ORDR_INVC."SRCDOC_TYPE",
						CUR_ORDR_INVC."SRCDOC_ID",
						CUR_ORDR_INVC."TIMESTAMP_UTC",
						CUR_ORDR_INVC."HEADER_ID",
						CUR_ORDR_INVC."RAI_ITEM_ID",
						CUR_ORDR_INVC."REFERENCE_TYPE",
						CUR_ORDR_INVC."REFERENCE_ID",
						CUR_ORDR_INVC."KUNNR",
						CUR_ORDR_INVC."BUKRS",
						CUR_ORDR_INVC."WAERS",
						CUR_ORDR_INVC."QUANTITY",
						CUR_ORDR_INVC."QUANTITY_UNIT",
						CUR_ORDR_INVC."BILREL",
						CUR_ORDR_INVC."START_DATE",
						CUR_ORDR_INVC."END_DATE",
						CUR_ORDR_INVC."XNEGATIVE_ITEM",
						CUR_ORDR_INVC."RECEIV_ACCOUNT",
						CUR_ORDR_INVC."INCEPTION_DT",
						CUR_ORDR_INVC."ZZ_AUFNR",
						:LV_BATCH_ID,
						CUR_ORDR_INVC."ZZ_BILLER",
						CUR_ORDR_INVC."ZZ_BKTXT",
						CUR_ORDR_INVC."ZZ_BU_VIEW",
						CUR_ORDR_INVC."ZZ_BUKRS",
						CUR_ORDR_INVC."ZZ_KOSTL",
						CUR_ORDR_INVC."ZZ_LEGACY",
						CUR_ORDR_INVC."ZZ_MATNR",
						CUR_ORDR_INVC."ZZ_MATNR_GRP",
						CUR_ORDR_INVC."ZZ_MINPRICE",
						CUR_ORDR_INVC."ZZ_MWSKZ",
						CUR_ORDR_INVC."ZZ_SGTXT",
						CUR_ORDR_INVC."ZZ_TXJCD",
						CUR_ORDR_INVC."ZZ_XBLNR",
						CUR_ORDR_INVC."ZZ_ZUONR_ORD",
						CUR_ORDR_INVC."VALUE_RELEVANT");

	--  		All valid records are inserted ORDER Condition table for SSP(Standalone Selling Price)         
				INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_COND"(
							"SRCDOC_COMP",
							"SRCDOC_LOGSYS",
							"SRCDOC_TYPE",
							"SRCDOC_ID",
							"TIMESTAMP_UTC",
							"CONDITION_TYPE",
							"PL_ACCOUNT",			
							"BETRW",
							"WAERS",
							"CATEGORY",
							"MAIN_COND_TYPE")
				     VALUES (CUR_ORDR_INVC."SRCDOC_COMP",
							CUR_ORDR_INVC."SRCDOC_LOGSYS",			
							CUR_ORDR_INVC."SRCDOC_TYPE",
							CUR_ORDR_INVC."SRCDOC_ID",
							CUR_ORDR_INVC."TIMESTAMP_UTC",
							CUR_ORDR_INVC."CONDITION_TYPE_SSP",
							CUR_ORDR_INVC."PL_ACCOUNT",
							CUR_ORDR_INVC."SSP",
							CUR_ORDR_INVC."WAERS",
							CUR_ORDR_INVC."CATEGORY",
							CUR_ORDR_INVC."MAIN_CONDITION_TYPE");

--  		All valid records are inserted ORDER Condition table for TP(Transaction Price)
				INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_COND"(
							"SRCDOC_COMP",
							"SRCDOC_LOGSYS",
							"SRCDOC_TYPE",
							"SRCDOC_ID",
							"TIMESTAMP_UTC",
							"CONDITION_TYPE",
							"PL_ACCOUNT",			
							"BETRW",
							"WAERS",
							"CATEGORY",
							"MAIN_COND_TYPE")
				     VALUES (CUR_ORDR_INVC."SRCDOC_COMP",
							CUR_ORDR_INVC."SRCDOC_LOGSYS",			
							CUR_ORDR_INVC."SRCDOC_TYPE",
							CUR_ORDR_INVC."SRCDOC_ID",
							CUR_ORDR_INVC."TIMESTAMP_UTC",
							CUR_ORDR_INVC."CONDITION_TYPE_TP",
							CUR_ORDR_INVC."PL_ACCOUNT",
							CUR_ORDR_INVC."TP",
							CUR_ORDR_INVC."WAERS",
							CUR_ORDR_INVC."CATEGORY",
							CUR_ORDR_INVC."MAIN_CONDITION_TYPE");	

	--  		All valid records are inserted into Invoice Main table 
				INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_INVC_MAIN"(
						"SRCDOC_COMP",
						"SRCDOC_LOGSYS",
						"SRCDOC_TYPE",
						"SRCDOC_ID",
						"TIMESTAMP_UTC",
						"HEADER_ID",
						"ITEM_ID",
						"KUNNR",
						"BUKRS",
						"WAERS",
						"HWAER",
						"QUANTITY",
						"QUANTITY_UNIT",
						"ORIGDOC_COMP",
						"ORIGDOC_LOGSYS",
						"ORIGDOC_TYPE",
						"ORIGDOC_ID",
						"DUE_DATE",
						"FINAL_INVOICE",
						"QUANTITY_REL",
						"POSTING_DATE",
						"EXCHANGE_RATE",
						"BLDAT",
						"ZZ_AUFNR",
						"ZZ_BATCH_ID",
						"ZZ_BKTXT",
						"ZZ_BLDAT",
						"ZZ_BUDAT",
						"ZZ_BUKRS",
						"ZZ_ICHKONT",
						"ZZ_KOSTL",
						"ZZ_LEGACY",
						"ZZ_MWSKZ",
						"ZZ_SGTXT",
						"ZZ_TXJCD",
						"ZZ_XBLNR",
						"ZZ_ZUONR")
				VALUES (CUR_ORDR_INVC."SRCDOC_COMP_INV",
						CUR_ORDR_INVC."SRCDOC_LOGSYS_INV",
						CUR_ORDR_INVC."SRCDOC_TYPE_INV",
						CUR_ORDR_INVC."SRCDOC_ID",
						CUR_ORDR_INVC."TIMESTAMP_UTC",
						CUR_ORDR_INVC."HEADER_ID",
						CUR_ORDR_INVC."RAI_ITEM_ID",
						CUR_ORDR_INVC."KUNNR",
						CUR_ORDR_INVC."BUKRS",
						CUR_ORDR_INVC."WAERS",
						CUR_ORDR_INVC."HWAER",
						CUR_ORDR_INVC."QUANTITY",
						CUR_ORDR_INVC."QUANTITY_UNIT",
						CUR_ORDR_INVC."SRCDOC_COMP",
						CUR_ORDR_INVC."SRCDOC_LOGSYS",
						CUR_ORDR_INVC."SRCDOC_TYPE",
						CUR_ORDR_INVC."SRCDOC_ID",
						CUR_ORDR_INVC."DUE_DATE",
						CUR_ORDR_INVC."FINAL_INVOICE",
						CUR_ORDR_INVC."QUANTITY_REL",
						CUR_ORDR_INVC."POSTING_DT",
						CUR_ORDR_INVC."EXCHANGE_RATE",
						CUR_ORDR_INVC."ZZ_BLDAT",
						CUR_ORDR_INVC."ZZ_AUFNR",
						LV_BATCH_ID,
						CUR_ORDR_INVC."ZZ_BKTXT",
						CUR_ORDR_INVC."ZZ_BLDAT",
						CUR_ORDR_INVC."ZZ_BUDAT",
						CUR_ORDR_INVC."ZZ_BUKRS",
						CUR_ORDR_INVC."ZZ_ICHKONT",
						CUR_ORDR_INVC."ZZ_KOSTL",
						CUR_ORDR_INVC."ZZ_LEGACY",
						CUR_ORDR_INVC."ZZ_MWSKZ",
						CUR_ORDR_INVC."ZZ_SGTXT",
						CUR_ORDR_INVC."ZZ_TXJCD",
						CUR_ORDR_INVC."ZZ_XBLNR",
						CUR_ORDR_INVC."ZZ_ZUONR_INV");

	--  		All valid records are inserted Invoice Condition table for TP(Transaction Price)         
				INSERT INTO "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_INVC_COND"(
							"SRCDOC_COMP",
							"SRCDOC_LOGSYS",
							"SRCDOC_TYPE",
							"SRCDOC_ID",
							"TIMESTAMP_UTC",
							"CONDITION_TYPE",
							"PL_ACCOUNT",			
							"BETRW",
							"WAERS",
							"CATEGORY",
							"MAIN_COND_TYPE")
				    VALUES (CUR_ORDR_INVC."SRCDOC_COMP_INV",
							CUR_ORDR_INVC."SRCDOC_LOGSYS_INV",			
							CUR_ORDR_INVC."SRCDOC_TYPE_INV",
							CUR_ORDR_INVC."SRCDOC_ID",
							CUR_ORDR_INVC."TIMESTAMP_UTC",
							CUR_ORDR_INVC."CONDITION_TYPE_TP",
							CUR_ORDR_INVC."PL_ACCOUNT",
							CUR_ORDR_INVC."TP",
							CUR_ORDR_INVC."WAERS",
							CUR_ORDR_INVC."CATEGORY",
							CUR_ORDR_INVC."MAIN_CONDITION_TYPE");
				
             
		    END;
   --     To get the SRCDOC_ID for each ALLOCATELOB  
   				IF ((LV_REFERENCE_ID IS NULL) OR (LV_REFERENCE_ID != CUR_ORDR_INVC."REFERENCE_ID")) OR 
                (((LV_SRCDOC_ID IS NULL) OR (LV_SRCDOC_ID != CUR_ORDR_INVC."CC_TEMP_SRCDOC_ID")) AND (LV_REFERENCE_ID = CUR_ORDR_INVC."REFERENCE_ID"))
                THEN
                LV_REFERENCE_ID  := CUR_ORDR_INVC."REFERENCE_ID";
                LV_SRCDOC_ID     := CUR_ORDR_INVC."CC_TEMP_SRCDOC_ID";
                LV_SRCDOC_ID_DTH := MAP(CUR_ORDR_INVC."DTH_SRCDOC_ID",NULL,NULL,CUR_ORDR_INVC."DTH_SRCDOC_ID");
                LV_SRCDOC_ID_FIBE := MAP(CUR_ORDR_INVC."FIBE_SRCDOC_ID",NULL,NULL,CUR_ORDR_INVC."FIBE_SRCDOC_ID");
                LV_SRCDOC_ID_HP := MAP(CUR_ORDR_INVC."HP_SRCDOC_ID",NULL,NULL,CUR_ORDR_INVC."HP_SRCDOC_ID");
                LV_SRCDOC_ID_INT := MAP(CUR_ORDR_INVC."INT_SRCDOC_ID",NULL,NULL,CUR_ORDR_INVC."INT_SRCDOC_ID");
                
                ELSEIF LV_REFERENCE_ID = CUR_ORDR_INVC."REFERENCE_ID" AND LV_SRCDOC_ID = CUR_ORDR_INVC."CC_TEMP_SRCDOC_ID" THEN
                   
                LV_SRCDOC_ID_DTH := MAP(CUR_ORDR_INVC."DTH_SRCDOC_ID",NULL,LV_SRCDOC_ID_DTH,CUR_ORDR_INVC."DTH_SRCDOC_ID");
                LV_SRCDOC_ID_FIBE := MAP(CUR_ORDR_INVC."FIBE_SRCDOC_ID",NULL,LV_SRCDOC_ID_FIBE,CUR_ORDR_INVC."FIBE_SRCDOC_ID");
                LV_SRCDOC_ID_HP := MAP(CUR_ORDR_INVC."HP_SRCDOC_ID",NULL,LV_SRCDOC_ID_HP,CUR_ORDR_INVC."HP_SRCDOC_ID");
                LV_SRCDOC_ID_INT := MAP(CUR_ORDR_INVC."INT_SRCDOC_ID",NULL,LV_SRCDOC_ID_INT,CUR_ORDR_INVC."INT_SRCDOC_ID");
                
                --CONCAT (LV_SRCDOC_ID,CONCAT ('|',CUR_ORDR_INVC."RAI_ITEM_ID"));
                
                END IF ;
                
	--  	Insert PK of successfully processed Records into Local Temp Tables 
	--  	for Updating NDB_TS in corresponding Landing Tables records
	 		INSERT INTO #UPDATE_TV_ORDER(
	   		 			ACCT_NUM, 
						ITEM_ID, 
						SRCDOC_ID,
						DTH_SRCDOC_ID,
						FIBE_SRCDOC_ID,
						HP_SRCDOC_ID,
						INT_SRCDOC_ID,
						SRCDOC_ID_NDB,
						REFERENCE_ID,
						SERVICE_CD,
						BATCH_ID,
						EXTR_DT,
						PRIN_NUM,
						AGNT_NUM,
						VTG_ROW_ID
						)
				 VALUES ( CUR_ORDR_INVC."ACCT_NUM",
		   		    	CUR_ORDR_INVC."RAI_ITEM_ID",
		   		    	CUR_ORDR_INVC."SRCDOC_ID",
		   		    	"LV_SRCDOC_ID_DTH",
		   		    	"LV_SRCDOC_ID_FIBE",
		   		    	"LV_SRCDOC_ID_HP",
		   		    	"LV_SRCDOC_ID_INT",
		   		    	:LV_SRCDOC_ID,
		   		    	CUR_ORDR_INVC."REFERENCE_ID",
		   		    	CUR_ORDR_INVC."SERVICE_CD",
		   		    	:LV_BATCH_ID,
		   		    	CUR_ORDR_INVC."EXTR_DT",
		   		    	CUR_ORDR_INVC."PRIN_NUM",
		   		    	CUR_ORDR_INVC."AGNT_NUM",
		   		    	CUR_ORDR_INVC."VTG_ROW_ID");

			 	        
			   		        
			INSERT INTO	#UPDATE_EH_DELETION_MAIN_TV (SRCDOC_ID) 
				 SELECT "SRCDOC_ID" 
				   FROM "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_MAIN"
				  WHERE "REFERENCE_ID" = CUR_ORDR_INVC."REFERENCE_ID"
				    AND "ZZ_BATCH_ID" = LV_BATCH_ID;
			   		
			INSERT INTO	#UPDATE_EH_DELETION_COND_TV (SRCDOC_ID) 
				 SELECT COND."SRCDOC_ID" 
				   FROM "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_COND" COND,
	                	(SELECT "SRCDOC_ID" 
	                	   FROM "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_MAIN"
					  	  WHERE "REFERENCE_ID" = CUR_ORDR_INVC."REFERENCE_ID"
					  	    AND "ZZ_BATCH_ID" = LV_BATCH_ID) MAIN 
				  WHERE COND."SRCDOC_ID" = MAIN."SRCDOC_ID";
				  
		  
							          												 		   		        		   	   
		END IF;

  END FOR ;
																														   
	--------------------------------------------------------------------------------------------------
	-- Update NDB Tables
	-------------------------------------------------------------------------------------------------- 
			
    --  Updating the Source document Id, Reference Id, Header Id, Time indicator, RAI Item ID,Batch id 
	--  and RAI Timestamp in in NDB order table for Term Contracts */
	  		  
		  UPDATE "NDB_TV"."IFRS_R1.BELLTV.NDB_BELLTV::TV_TRANSACTIONS" A
		  FROM "NDB_TV"."IFRS_R1.BELLTV.NDB_BELLTV::TV_TRANSACTIONS" A
		 INNER JOIN #UPDATE_TV_ORDER B 
		    ON A.ACCT_NUM   = B.ACCT_NUM
		   AND A.SERVICE_CD = B.SERVICE_CD 
		   AND A.EXTR_DT    = B.EXTR_DT
		   AND A.VTG_ROW_ID = B.VTG_ROW_ID
		   AND A.PRIN_NUM   = B.PRIN_NUM
		   AND A.AGNT_NUM   = B.AGNT_NUM 
		   SET A."SRCDOC_ID"   = B.SRCDOC_ID,
		       A."DTH_SRCDOC_ID" = B."DTH_SRCDOC_ID", 
		       A."FIBE_SRCDOC_ID"= B."FIBE_SRCDOC_ID",
		       A."HP_SRCDOC_ID"  = B."HP_SRCDOC_ID",
		       A."INT_SRCDOC_ID" = B."INT_SRCDOC_ID",
			   "REFERENCE_ID"  = B."REFERENCE_ID",
			   "ITEM_ID"       = B."ITEM_ID",			
			   "HEADER_ID"     = B."ACCT_NUM",
			   "BATCH_ID_ORD"  = B."BATCH_ID",
			   "BATCH_ID_INV"  = B."BATCH_ID",
			   "RAI_TS_ORD"    = LV_CUR_UTC,
			   "RAI_TS_INV"    = LV_CUR_UTC;

    
	--  Update Order Main Error Table
		UPDATE "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_MAIN_EH" A
		  FROM "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_MAIN_EH" A
		 INNER JOIN #UPDATE_EH_DELETION_MAIN_TV B
		    ON A.SRCDOC_ID=B.SRCDOC_ID
		   SET (DELETE_DATE, DELETED) = (CURRENT_DATE, 1); 
		
	--  Update Order Cond Error Table
		UPDATE "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_COND_EH" A
		  FROM "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_ORDR_COND_EH" A
		 INNER JOIN #UPDATE_EH_DELETION_COND_TV B
		    ON A.SRCDOC_ID=B.SRCDOC_ID
		   SET (DELETE_DATE, DELETED) = (CURRENT_DATE, 1); 
				
	--  Update Invoice Main Error Table
		UPDATE "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_INVC_MAIN_EH" A
		  FROM "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_INVC_MAIN_EH" A
		 INNER JOIN #UPDATE_EH_DELETION_MAIN_TV B
		    ON A.SRCDOC_ID=B.SRCDOC_ID
		   SET (DELETE_DATE, DELETED) = (CURRENT_DATE, 1); 
		
	--  Update Invoice Cond Error Table
		UPDATE "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_INVC_COND_EH" A
		  FROM "RAI_TV"."IFRS_R1.BELLTV.RAI_BELLTV::BELLTV_INVC_COND_EH" A
		 INNER JOIN #UPDATE_EH_DELETION_COND_TV B
		    ON A.SRCDOC_ID=B.SRCDOC_ID
		   SET (DELETE_DATE, DELETED) = (CURRENT_DATE, 1); 				
	-------------------------------------------------------------------------------------------------
	-- Set Overall Status
	-------------------------------------------------------------------------------------------------- 
	
	--  STATUS 0: Send the success message to scheduling tool to confirm this procedure has been
	--  executed successfully
		IF(LV_ERROR_FLAG = 'Y') THEN		
	
	     OP_STATUS := LC_ERROR_TEXT; 
				
		ELSE
	
	  	 OP_STATUS := LC_SUCCESS_TEXT; 	
					
		END IF;
	
	END;

END; 