PROCEDURE "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::Test_procedure" ( ) 
	LANGUAGE SQLSCRIPT
	SQL SECURITY INVOKER 
	--DEFAULT SCHEMA <default_schema_name>
	--READS SQL DATA
	 AS
	
	
BEGIN
/***************************** 
	Write your procedure logic 
 *****************************/
 
 
		DECLARE CURSOR C_CUR_INRT FOR SELECT
			 "MARKET_CODE",
			 "MARKET_NAME",
			 "RELATED_MARKET",
			 "ALT_MARKET_NAME",
			 "EFF_DT",
			 "EXPY_DT",
			 CURRENT_DATE V_DATE	 
		FROM "LAND"."IFRS_R1.LAND::IFRS_OB_MARKET" LAND
		WHERE NOT EXISTS (SELECT
			 NDB."MARKET_CODE" 
			FROM "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::OB_MARKET" NDB 
			WHERE NDB."MARKET_CODE" = LAND."MARKET_CODE" 
			AND NDB."REFERENCE_EFFECTIVE_DT" > LAND."EFF_DT");
		
		DECLARE CURSOR C_CUR_UPDT FOR SELECT
			 "MARKET_CODE",
			 "EFF_DT",
			 CURRENT_DATE V_DATE	 
		FROM "LAND"."IFRS_R1.LAND::IFRS_OB_MARKET" LAND
		WHERE EXISTS (SELECT
			 NDB."MARKET_CODE" 
			FROM "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::OB_MARKET" NDB 
			WHERE NDB."MARKET_CODE" = LAND."MARKET_CODE" 
			AND NDB."REFERENCE_EXPIRY_DT" > LAND."EFF_DT");
			
			
	FOR  R1 AS C_CUR_UPDT DO
	
	 DECLARE EXIT HANDLER FOR SQLEXCEPTION 
		BEGIN AUTONOMOUS TRANSACTION 
		INSERT 
		INTO "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::OB_ERROR_LOG" ( "PROCEDURE_ID",
			"PROCEDURE_NAME",
			 "ERROR_CODE",
			 "ERROR_MESSAGE",
			 "START_END_TIME" ) VALUES ( '123',
			 'test_Update',
			 ::SQL_ERROR_CODE,
			 'While UPDATE '|| ::SQL_ERROR_MESSAGE||' '||'Market_code'||' '||R1."MARKET_CODE",
			 CURRENT_DATE );
		 COMMIT;
		-- RESIGNAL;		 
		END;
	
		UPDATE "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::OB_MARKET" SET ("REFERENCE_EXPIRY_DT",
			 "MODIFIED_TS"
				 ) =
				  (NULL, R1.V_DATE)
		WHERE MARKET_CODE = R1.MARKET_CODE;
		
	END FOR; 
			
	FOR  R1 AS C_CUR_INRT DO
	
		 DECLARE EXIT HANDLER FOR SQLEXCEPTION 
		BEGIN AUTONOMOUS TRANSACTION 
		INSERT 
		INTO "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::OB_ERROR_LOG" ( "PROCEDURE_ID",
			"PROCEDURE_NAME",
			 "ERROR_CODE",
			 "ERROR_MESSAGE",
			 "START_END_TIME" ) VALUES ( '123',
			 'test_insert',
			 ::SQL_ERROR_CODE,
			 'While Insert '|| ::SQL_ERROR_MESSAGE||' '||'Market_code'||' '||R1."MARKET_CODE",
			 CURRENT_DATE );
		 COMMIT;
		-- RESIGNAL ;		 
		END;
	
	

		INSERT INTO  "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::OB_MARKET" ("MARKET_CODE",
			 "MARKET_NAME",
			 "RELATED_MARKET",
			 "ALT_MARKET_NAME",
			 "REFERENCE_EFFECTIVE_DT",
			 "REFERENCE_EXPIRY_DT",
			 "INSERT_TS"
				 ) VALUES(R1."MARKET_CODE",
			 R1."MARKET_NAME",
			R1."RELATED_MARKET",
		R1."ALT_MARKET_NAME",
			 R1."EFF_DT",
			R1."EXPY_DT",
			R1.V_DATE);
		
	END FOR; 
	
END;
