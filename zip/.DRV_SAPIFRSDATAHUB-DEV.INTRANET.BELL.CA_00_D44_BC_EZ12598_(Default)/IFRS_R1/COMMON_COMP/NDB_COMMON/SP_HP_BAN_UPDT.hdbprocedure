PROCEDURE "NDB_COMMON"."IFRS_R1.COMMON_COMP.NDB_COMMON::SP_HP_BAN_UPDT"
(OUT OT_STATUS NVARCHAR(1000))  
	LANGUAGE SQLSCRIPT
	SQL SECURITY INVOKER 
	--DEFAULT SCHEMA <default_schema_name>
	--READS SQL DATA 
	AS
BEGIN
-- Procedure Title : SP_HP_BAN_UPDT
--
-- Created By      : BC_EZ07674(Suresh Konidala)          Date :02/12/2016
-- 
-- Procedure Description : This is a stored procedure designed to update One Bill BAN from    
--						   OB_CUSTOMER to HP_CUSTOMER table in NDB.
-- Project :Bell Canada
-- 
-- Release :R1/IFRS
--------------------------------------------------------------------------------
--   M O D I F I C A T I O N   H I S T O R Y
--------------------------------------------------------------------------------
-- Date        | User ID          | Modification History/Release
--------------------------------------------------------------------------------
--             |                  | 
--------------------------------------------------------------------------------
-- Description Of the changes 
--------------------------------------------------------------------------------
-- Modification Number          :<Assign Some Number> 
-- Description of Changes Made> :<Description of Changes>       
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
-- Local Variables Declaration
--------------------------------------------------------------------------------------------------
DECLARE LV_CUR_UTC 				TIMESTAMP := CURRENT_TIMESTAMP;
DECLARE LV_ERROR_FLAG 		NVARCHAR(1) := 'N';
DECLARE LC_ERROR_TEXT 			NVARCHAR(120) 
            					DEFAULT 'OUT STATUS IS 1 : PROCEDURE 
            			IFRS_R1.COMMON_COMP.NDB_COMMON::SP_HP_BAN_UPDT UPDATE EXECUTION FAILED';
DECLARE LC_SUCCESS_TEXT 		NVARCHAR(120) 
								DEFAULT 'OUT STATUS IS 0 : PROCEDURE 
					IFRS_R1.COMMON_COMP.NDB_COMMON::SP_HP_BAN_UPDT UPDATE EXECUTION SUCCESSFUL';
--------------------------------------------------------------------------------------------------
-- Cursors Declaration
-------------------------------------------------------------------------------------------------- 
DECLARE CURSOR C_HP_BAN_UPDT FOR
	   SELECT
		 "CBSS_CAN",
		 "ONE_BILL_BAN"
		FROM "_SYS_BIC"."IFRS_R1.COMMON_COMP.NDB_COMMON/CA_HP_BAN_UPDT";
		
--------------------------------------------------------------------------------------------------
-- Local Temporary Tables Declaration
-------------------------------------------------------------------------------------------------- 
CREATE LOCAL TEMPORARY TABLE #UPDATE_EH_DELETION ("CBSS_CAN" NVARCHAR(10));
--------------------------------------------------------------------------------------------------
-- Cursors Loop
--------------------------------------------------------------------------------------------------  

FOR HP_BAN AS C_HP_BAN_UPDT DO
	--  Define Exit Handler
	DECLARE EXIT HANDLER FOR SQLEXCEPTION 
	BEGIN AUTONOMOUS TRANSACTION 
	
	  -- Define Exit Handler
	  DECLARE EXIT HANDLER FOR SQLEXCEPTION 
	  BEGIN AUTONOMOUS TRANSACTION 	
	   
	     -- Do Nothing. Exception Handled to ensure SP does not get terminated 
	
 	  END;
	
   	  -- Insert record into error table
	  INSERT INTO "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_CUSTOMER_EH"
	   	  ("CBSS_CAN",
	   	  	"ONE_BILL_BAN", 
			"ERROR_CODE",
			"TECHNICAL_MESSAGE",
			"ERROR_CREATE_TS")
	  VALUES( HP_BAN."CBSS_CAN",
	  		  HP_BAN."ONE_BILL_BAN",
			  ::SQL_ERROR_CODE,
			  ::SQL_ERROR_MESSAGE,
			  LV_CUR_UTC);
	  LV_ERROR_FLAG := 'Y';    
	END;
	
	UPDATE "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_CUSTOMER"
	SET "ONE_BILL_BAN" = HP_BAN."ONE_BILL_BAN", "MODIFIED_TS" = LV_CUR_UTC
	WHERE "CBSS_CAN" = HP_BAN."CBSS_CAN";
	
	INSERT INTO #UPDATE_EH_DELETION
			      ("CBSS_CAN") 
		   VALUES (HP_BAN."CBSS_CAN");
END FOR ;
		
--------------------------------------------------------------------------------------------------
--  Update Error Table
--------------------------------------------------------------------------------------------------

	UPDATE "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_CUSTOMER_EH" A
    FROM "NDB_HP"."IFRS_R1.HP.NDB_HP::HP_CUSTOMER_EH" A 
    INNER JOIN #UPDATE_EH_DELETION B
    ON  A."CBSS_CAN"            =   B."CBSS_CAN"
    SET (DELETE_DATE, DELETED)      =   (CURRENT_DATE, 1);

--------------------------------------------------------------------------------------------------
-- Set Overall Status
-------------------------------------------------------------------------------------------------- 

--  STATUS 0: Send the success message to scheduling tool to confirm this procedure has been
--  executed successfully
    IF(LV_ERROR_FLAG = 'Y') THEN		

       OT_STATUS := LC_ERROR_TEXT;
			
    ELSE
 
  	   OT_STATUS := LC_SUCCESS_TEXT; 	
				
	END IF;

END;
